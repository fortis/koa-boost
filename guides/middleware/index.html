<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Middleware - Guides - Mongorito</title>
    
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,400italic" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/guides-52985f47.css" rel="stylesheet" type="text/css" />
  </head>
  
  <body class="guides guides_middleware guides_middleware_index">
    <div class="container">
      <nav class="navbar row">
        <ul class="nine columns">
          <li><a class="logo" href="/"><i class="icon icon-home"></i></a></li>
          <li><a href="/">Mongorito</a></li>
          <li><a href="/guides/getting-started">Quick Start</a></li>
          <li><a href="/guides">Guides</a></li>
        </ul>
        
        <ul class="three columns">
          <li><a href="https://github.com/vdemedes/mongorito" target="_blank">Github</a></li>
        </ul>
      </nav>
      
      <h1>Middleware</h1>

<p>After reading this guide you will know:</p>

<ol>
<li>How to configure middleware in models</li>
<li>Abort the operation and throw error</li>
<li>Use an alternative API for defining middleware</li>
</ol>

<blockquote>
<p>This guide assumes that you have a basic knowledge of Mongorito and you&rsquo;ve already read <a href="/guides/getting-started">Getting Started</a> guide.</p>
</blockquote>

<h3>Configuration</h3>

<p>Middleware is a known concept to Node.js community.
It&rsquo;s basically a chain of functions that execute sequentially and change the state of context.
Mongorito implements the same behavior.
Whether you are creating, updating or removing documents, you can &ldquo;inject&rdquo; a function in the chain.
This could be useful for validation, data consistency confirmation, checking for existing data, hooks for other events, etc.</p>

<blockquote>
<p>Every middleware function <strong>must</strong> be a generator function.</p>
</blockquote>

<p>Let&rsquo;s define a Post model for our examples:</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">Mongorito</span><span class="p">.</span><span class="nx">Model</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">Post</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>

<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>Now, let&rsquo;s see how a Post model will look with a pre-create middleware:</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="kr">class</span> <span class="nx">Post</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
    <span class="nx">configure</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'checkIfExists'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="o">*</span> <span class="nx">checkIfExists</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// checking if post with the</span>
        <span class="c1">// same title exists in database</span>

        <span class="nx">yield</span> <span class="nx">next</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>In this model, <mark>.configure()</mark> method is like a constructor, it is executed when a new instance of Post model is created.
In this method, you should &ldquo;register&rdquo; your middleware.
Every middleware function accepts only one argument, <mark>next</mark> callback, which should be called when function had done its job.</p>

<p>There are 3 frames, where you can inject middleware: <em>before</em>, <em>after</em> and <em>around</em>.
Last one, <em>around</em>, is the mix of <em>before</em> and <em>after</em>, which means that middleware registered with <em>around</em> will be executed twice, before and after the operation.</p>

<p>There are 4 events, when middleware can be triggered: <em>save</em>, <em>create</em>, <em>update</em> and <em>remove</em>.
If middleware registered to trigger on <em>save</em>, it will be triggered on both <em>create</em> and <em>update</em> events.</p>

<p>Here&rsquo;s the full example of <mark>.configure()</mark> on how you may register middleware:</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="nx">configure</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'executesBeforeCreate'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">around</span><span class="p">(</span><span class="s1">'update'</span><span class="p">,</span> <span class="s1">'executesAroundUpdate'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="s1">'remove'</span><span class="p">,</span> <span class="s1">'executesAfterRemove'</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<blockquote>
<p>Middleware gets executed automatically. Keep using the same API for managing data just like before.</p>
</blockquote>

<h3>Aborting the operation</h3>

<p>There are times, when you need to prevent the main operation (save, remove) from happening.
For example, after failed validation of incoming data.
To abort middleware chain and prevent operation from executing, just throw an error, like you usually do:</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre></td><td class="code"><pre><span class="kr">class</span> <span class="nx">Post</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
    <span class="nx">configure</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="s1">'save'</span><span class="p">,</span> <span class="s1">'validate'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="o">*</span> <span class="nx">validate</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">isValid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="c1">// let's assume that validation went wrong</span>
        <span class="c1">// and isValid is set to false here</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isValid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'Post title is missing'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">yield</span> <span class="nx">next</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Post</span><span class="p">();</span>
<span class="nx">yield</span> <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
</pre></td></tr></tbody></table>
</div>

<p>After the <em>Error</em> is thrown, nothing will be executed.
Use <em>try/catch</em> construction to catch errors.</p>

      
      <footer>Made by <a href="https://twitter.com/vdemedes" target="_blank">Vadim Demedes</a></footer>
    </div>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" type="text/javascript"></script>
    
    <script>
  	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  	  ga('create', 'UA-56814364-1', 'auto');
  	  ga('send', 'pageview');
  	</script>
  </body>
</html>