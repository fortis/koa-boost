<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Query Population - Guides - Mongorito</title>
    
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,400italic" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/guides-52985f47.css" rel="stylesheet" type="text/css" />
  </head>
  
  <body class="guides guides_query-population guides_query-population_index">
    <div class="container">
      <nav class="navbar row">
        <ul class="nine columns">
          <li><a class="logo" href="/"><i class="icon icon-home"></i></a></li>
          <li><a href="/">Mongorito</a></li>
          <li><a href="/guides/getting-started">Quick Start</a></li>
          <li><a href="/guides">Guides</a></li>
        </ul>
        
        <ul class="three columns">
          <li><a href="https://github.com/vdemedes/mongorito" target="_blank">Github</a></li>
        </ul>
      </nav>
      
      <h1>Query Population</h1>

<p>After reading this guide you will know:</p>

<ol>
<li>How to populate query response with other models</li>
<li>Save yourself a shitload of time</li>
</ol>

<blockquote>
<p>This guide assumes that you have a basic knowledge of Mongorito and you&rsquo;ve already read <a href="/guides/getting-started">Getting Started</a> guide.</p>
</blockquote>

<h3>What is Query Population?</h3>

<p>Idea of query population was borrowed from the awesome <a href="http://mongoosejs.com/docs/populate.html">Mongoose</a> (Thank you!).
Query population comes really handy when in query response you have references to documents in other collections (ObjectIDs, for example) and you need to query those documents too in order to get a complete data.</p>

<p>Let&rsquo;s take a look at this example to get a better understanding. Imagine you have such Post document in a database:</p>
<div class="highlight json"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="p">{</span><span class="w">
    </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"5234d25244e937489c000004"</span><span class="err">)</span><span class="p">,</span><span class="w">
    </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Great title"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Great body"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"comments"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="err">ObjectId(</span><span class="s2">"5234d25244e937489c000005"</span><span class="err">)</span><span class="p">,</span><span class="w">
        </span><span class="err">ObjectId(</span><span class="s2">"5234d25244e937489c000006"</span><span class="err">)</span><span class="p">,</span><span class="w">
        </span><span class="err">ObjectId(</span><span class="s2">"5234d25244e937489c000007"</span><span class="err">)</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table>
</div>

<p>And there are Post and Comment models defined:</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">Mongorito</span><span class="p">.</span><span class="nx">Model</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">Post</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>

<span class="p">}</span>

<span class="kr">class</span> <span class="nx">Comment</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>

<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>Now, to fetch this post and its comments normally you would do this (or something like this):</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">findOne</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">comments</span> <span class="o">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">commentId</span><span class="p">;</span>

<span class="k">while</span> <span class="p">(</span><span class="nx">commentId</span> <span class="o">=</span> <span class="nx">comments</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">comments</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">Comment</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">commentId</span><span class="p">);</span>

    <span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>First, you fetch a post document. Then, you iterate over comments array and for each comment id fetch a comment document.
With populating, you don&rsquo;t need to write all that and instead just do this:</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="nx">Comment</span><span class="p">).</span><span class="nx">findOne</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">comments</span> <span class="o">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="err">'</span><span class="nx">comments</span><span class="p">);</span>
</pre></td></tr></tbody></table>
</div>

<p>Here, <mark>.populate()</mark> method tells a query, that <mark>comments</mark> field in the response needs to be replaced with documents fetched using <mark>Comment</mark> model. Yes, that easy.</p>

<blockquote>
<p>When you will try to save a document, which contains field(s) that were populated, they will be converted back to ObjectIDs, so document state will be the same before population.</p>
</blockquote>

      
      <footer>Made by <a href="https://twitter.com/vdemedes" target="_blank">Vadim Demedes</a></footer>
    </div>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" type="text/javascript"></script>
    
    <script>
  	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  	  ga('create', 'UA-56814364-1', 'auto');
  	  ga('send', 'pageview');
  	</script>
  </body>
</html>